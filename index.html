<!-- NOTE:: This uses a cookie to pass the username from the login screen
	    to the client screen. Chrome does not support cookies for local 
	    files. It **should** work in Chrome when deployed, but it must
	    be tested locally in a different browser
-->

<html>
  <head>

    <link rel="stylesheet" type="text/css" href="webUI.css">

  </head>

  <body class="body">
    <div class="left-column">
      <h3>
				Channel List
      </h3>
      <div id="channel-list">

			<button class="channel-button">test</button>

      </div>

      <button class="logout-button"name="logout"type="button" onclick="logout();">LOGOUT</button>
    </div>

    <!--top bar-->
    <div class="top-bar">
		<code id="channel-title">test</code>
    </div>

    <!--right -->
    <div class="right">
      <h3>
	Online
      </h3>
      <div id="online-list">
				<button class="online-button">test</button>
      </div>
    </div>

    <!--center-->
    <div class="center">
      <div id="chat-log">
      </div>

      <div class="textarea">
	>&nbsp
	<div class="textbox">
	  <input type="text"autocomplete="off" placeholder="Say Something!"id="chat-prompt"onkeydown="if(event.keyCode == 13)
											parseInput();"/>
	</div>
	<div class="textbutton">
	  <input type="button" id="textbutton" Value="Send" onclick="parseInput();"/>
	</div>
      </div>

    </div>

  </body>

</html>
  
<script src ="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script type="text/javascript">
	

  //current channel
  var channel = new channelClass("Default Channel");
	var testMsg = {
									"user" : "nathalie",
									"command" : "MSG",
									"args" : ["Default Channel","This is a test of the emergency preparedness system"],
									"timestamp" : 1326439500
								};

	channel.messages.push(testMsg);

  //channels currently "joined"
  var channels = [channel];

	//store lists retrieved from server
	var chanList = channels;
	var usrList = [];

	//DEBUG
	chanList.push(new channelClass("Other Channel"));
	usrList.push("Dan");
	usrList.push("Anthony");

	var sock = new WebSocket("ws://127.0.0.1/server.py");

	joinChannel(channel.name);


  //must be logged in to access this page
  if(!document.cookie)
  {
    window.location="login.html";
  }

	function updateTopBar()
	{
		document.getElementById("channel-title").innerHTML = channel.name;
	}

	function populateChannelList()
	{
		document.getElementById("channel-list").innerHTML="";
		for(var i=0;i<chanList.length;++i)
		{
			var btn = '<button class="channel-button" onclick="joinChannel(\''+chanList[i].name+'\');"><code>'+chanList[i].name+'</code></button>';
			document.getElementById("channel-list").innerHTML+=btn+"<br>";
		}
	}

	//define channel as local class
	function channelClass(name)
	{
		this.name = name;
		//messages is a list of JSON object messages from the server.
		//client messages must be wrapped in JSON objects
		this.messages = [];
	}
	
	function populateOnlineList()
	{
		document.getElementById("online-list").innerHTML="";
		for(var i=0;i<usrList.length;++i)
		{
			var arg = "'/msg ";
			arg += usrList[i];
			arg+=" '";
			var btn = '<button class="online-button" onclick="getElementById(\'chat-prompt\').value='+arg+'"><code>'+usrList[i]+'</code></button>';
			document.getElementById("online-list").innerHTML+=btn+"<br>";
		}
	}


  //sends object to sever
  function send(e)
  {
		sock.send(JSON.stringify(e));
	}

	//recieve data from server
	sock.onmessage = function(event)
	{
		var msg = JSON.parse(event.data);
		//do something
		switch(msg.command){ 
			case "USERLIST":
				usrList = msg.args;
				populateOnlineList();
				break;
			case "CHANLIST":
				chanList = msg.args;
				populateChannelList();
				break;
		}
	};

  //login with server
  var userName = document.cookie.split('=')[1];
  var usrMsg = {
									"command" : "USER",
									"args" : [userName]
							 };
  send(usrMsg);

  //gets user list from server, returns as array of strings
  function requestUsrList()
  {
		var msg = {
						"command" : "USERLIST",
						"args" : []
							};
		send(msg);
  }

  //joins the channels specified by a string
  function joinChannel(e)
  {
		console.log(e);
		populateChannelList();
		populateOnlineList();
		updateTopBar();
		var found = false;
		var tmp;
		for(var i =0;i<channels.length;++i)
		{
			if(channels[i].name == e)
			{
				found = true;
				tmp = channels[i];
			}
		}
		if (found)
		{
			channel = tmp;
			updateTopBar();
			printChannelMessages(tmp);
		}
		else
		{
			var msg = {
									"command" : "JOIN",
									"args" : [e]
								};
			send(msg);
			tmp = new channelClass(e);
			channels.push(tmp);
			channel = tmp;
			updateTopBar();
			populateChannelList();
			printChannelMessages(tmp);
		}
  }

  //leaves the channels specified by an array of channelObjs
  function part(e)
  {

		var arr;
		for (var c in e)
		{
			if(c.name)
				arr.push(c.name);
		}
    var msg = {
								"command" : "PART",
								"args" : c
							};
    send(msg);
		//TODO remove e from channels
  }

  //invite users to channel
  //args in the form [channel name, user0, user1,..,usern]
  function invite(e)
  {
    var msg = {
								"command" : "INVITE",
								"args" : e
							};
    send(msg);
  }

  //list channels on server
  function requestChanList()
  {
    var msg = {
								"command" : "CHANLIST",
								"args" : []
							};
    send(msg); //get list from server?
  }

  function createCookie(name,value,days) 
	{
    if (days) {
      var date = new Date();
      date.setTime(date.getTime()+(days*24*60*60*1000));
      var expires = "; expires="+date.toUTCString();
    }
    else 
    {
      var expires = "";
    }
    document.cookie = name+"="+value+expires+"; path=/";
  }
	
	function logout()
	{
  	part(channels);
		createCookie("user","",-1);
		sock.close();
		window.location="login.html";

	}

	function printChannelMessages(e)
	{
		console.log("printChannelMessages");
		document.getElementById("chat-log").innerHTML="";

		for(var i in e.messages)
		{
			if(i.args && i.args[1])
			{
				console.log("success!");
				var msg="";
				msg += i.timestamp+"\t"+i.user+"\t"+i.args[i];
				document.getElementById("chat-log").innerHTML+="<code>"+msg+"</code>";
			}

		}
	}

  function parseInput()
  {
    var msgTxt = document.getElementById("chat-prompt").value;
    var msgArr = msgTxt.split(" ");
    var msg;
    document.getElementById("chat-prompt").value = "";
populateChannelList();
populateOnlineList();
updateTopBar();
    
    //if input begins with /validUsrName, send private message
    if (msgTxt.match(/^\/msg(\s|$)/) && !!~usrList.indexOf(msgArr[1]))
    {
      msgArr.shift();
      msgArr.shift();
      msgTxt = msgArr.join(" ");
      msg = {
							"command" : "PRIVMSG",
							"args" : [msgArr[1],msgTxt]
						};
      send(msg);
    }

		//join
		else if(msgTxt.match(/^\/join\s+s*[^\s<>][^<>]+/))
		{
			msgArr.shift();
			arr = msgArr.join(" ").match(/[^<>]+/);
			joinChannel(arr[0].trim());
		}

    //logout, logoff
    //parts all channels, logs out
    else if (msgTxt.match(/^\/logoff(\s|$)/) || msgTxt.match(/^\/logout(\s|$)/))
    {
			logout();
    }

    //default, send message to current channel
    else if (msgTxt != "" && msgTxt != null)
		{
      msg = {
              "command" : "MSG",
							"args" : [channel.name, msgTxt]
						};
      send(msg);
    }
  }
</script>
