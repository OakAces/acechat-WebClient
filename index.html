<!-- NOTE:: This uses a cookie to pass the username from the login screen
	    to the client screen. Chrome does not support cookies for local 
	    files. It works in Chrome when deployed, but it must
	    be tested locally in a different browser - no longer true; works locally 
			in chrome if pointed to local server
-->

<html>
  <head>

    <link rel="stylesheet" type="text/css" href="webUI.css">
		<title>AceChat</title>

  </head>

  <body id="body" class="body">
    <div class="left-column">
      <h3>
				Channel List
      </h3>
      <div id="channel-list">

			<button class="channel-button">test</button>

      </div>

      <button class="logout-button"name="logout"type="button" onclick="logout();">LOGOUT</button>
    </div>

    <!--top bar-->
    <div class="top-bar">
		<code id="channel-title">test</code>
    </div>

    <!--right -->
    <div class="right">
      <h3>
				Online
      </h3>
      <div id="online-list">
				<button class="online-button">test</button>
      </div>
			<h2 id="online-channel-header">
			</h2>
			<div id="online-channel-list">
			</div>
    </div>

    <!--center-->
    <div class="center">
			<div id="chat-log-wrapper">
				<div id="chat-log">
				</div>
      </div>

      <div class="textarea">
	>&nbsp
	<div class="textbox">
	  <input type="text"autocomplete="off" placeholder="Say Something!"id="chat-prompt"onkeydown="if(event.keyCode == 13)
											parseInput();"/>
	</div>
	<div class="textbutton">
	  <input type="button" id="textbutton" Value="Send" onclick="parseInput();"/>
	</div>
      </div>

    </div>

  </body>

</html>
  
<script type="text/javascript">
	
	//var sock = new WebSocket("ws://45.55.80.240");
	var sock = new WebSocket("ws://localhost:9090");

	var userName;

  //current channel
  var channel="";

	//store lists retrieved from server
	var usrList = [];
	var chanUsrList = [];

  //channels currently "joined"
  var channels = [];
	var chanList = [];

	sock.onopen= function()
	{
		//must be logged in to access this page
		if(!document.cookie)
		{
			window.location="login.html";
		}

		//login with server
		userName = document.cookie.split('=')[1];
		if(userName.toLowerCase() == "acechat" || userName.match(/[<>]+/) || userName.match(/&gt;/) || userName.match(/&lt;/))
		{
			logout();
		}
		var usrMsg = {
										"command" : "USER",
										"args" : [userName]
								 };
		send(usrMsg);

		joinChannel("Default Channel",welcomeMsg());
		requestUsrList();
		requestChanList();
	};

	sock.onclose = function()
	{
		document.getElementById("body").innerHTML="<p style='color:white'>Failed to connect to server</p>";
	};


	//updates top bar and online-channel-list header
	function updateTopBar()
	{
		document.getElementById("channel-title").innerHTML = channel.name;
		document.getElementById("online-channel-header").innerHTML = channel.name;
	}

	function populateChannelList()
	{
		document.getElementById("channel-list").innerHTML="";
		for(var i=0;i<chanList.length;++i)
		{
			var btn = '<button class="channel-button" onclick="joinChannel(\''+chanList[i].name+'\');"><code>'+chanList[i].name+'</code></button>';
			document.getElementById("channel-list").innerHTML+=btn+"<br>";
		}
	}

	//define channel as local class
	function channelObj(name)
	{
		this.name = name;
		//messages is a list of JSON object messages from the server.
		//client messages must be wrapped in JSON objects
		this.messages = [];
	}

	function populateOnlineChannelList() //notimplemented serverside yet
	{
		document.getElementById("online-channel-list").innerHTML="";
		for(var i=0;i<chanUsrList.length;++i)
		{
			var arg = "'/msg ";
			arg += chanUsrList[i];
			arg+=" '";
			var btn = '<button class="online-button" onclick="getElementById(\'chat-prompt\').value='+arg+'"><code>'+chanUsrList[i]+'</code></button>';
			document.getElementById("online-channel-list").innerHTML+=btn+"<br>";
		}
	}
	
	function populateOnlineList()
	{
		document.getElementById("online-list").innerHTML="";
		for(var i=0;i<usrList.length;++i)
		{
			var arg = "'/msg ";
			arg += usrList[i];
			arg+=" '";
			var btn = '<button class="online-button" onclick="getElementById(\'chat-prompt\').value='+arg+'"><code>'+usrList[i]+'</code></button>';
			document.getElementById("online-list").innerHTML+=btn+"<br>";
		}
	}


  //sends object to sever
  function send(e)
  {
		sock.send(JSON.stringify(e));
	}

	//recieve data from server
	sock.onmessage = function(event)
	{
		var msg = JSON.parse(event.data);
		//do something
		switch(msg.command){ 
			case "USERLIST":
				usrList = msg.args;
				populateOnlineList();
				break;
			case "CHANLIST":
				tmp = msg.args;
				for(var i in tmp)
				{
					if(!getChannel(msg.args[i]))
						chanList.push(new channelObj(tmp[i]));
				}
				populateChannelList();
				break;
			case "MSG":
				channels[getChannel(msg.args[0])].messages.push(msg);
				printChannelMessages(channel);
				break;
			case "PRIVMSG":
				for(var i in channels)
				{
					channels[i].messages.push(msg);
				}
				printChannelMessages(channel);
				break;
			case "JOIN":
				var tmp =""+msg.user+" JOINED "+msg.args[0];
				msg.user = "AceChat";
				msg.args.push(tmp);
				getChannel(msg.args[0]).messages.push(tmp);
				if(channel == channels[getChannel(msg.args[0])])
					printChannelMessages(channel);
				break;
			case "PART":
				var tmp =""+msg.user+" PARTED "+msg.args[0];
				msg.user = "AceChat";
				msg.args.push(tmp);
				channels[getChannel(msg.args[0])].messages.push(tmp);
				if(channel == channels[getChannel(msg.args[0])])
					printChannelMessages(channel);
				break;
			case "ERROR":
				errorHandler(msg.args[0]);
				break;

		}
	};

	window.onload = function focus()
	{
		document.getElementById('chat-prompt').focus();
	};

	//input: channel name (string)
	//output: channelObj
	function getChannel(s)
	{
		for(var i in chanList)
		{
			if(chanList[i].name == s)
				return i;
		}
		return null;
	}


  	//accepts a channel and a string containing an error message. 
	//server errors must be wrapped in the onmessage function
	function errorHandler(e)
	{
		msg = {
						"user" : "AceChat",
						"command" : "ERROR",
						"args" : [channel,e],
						"timestamp" : new Date().getTime()/1000
					};

		channel.messages.push(msg);
		printChannelMessages(channel);
		
	}


	function chanMsg(e)
	{
		var welcome = {
										"user" : "AceChat",
										"command" : "SYSTEM",
										"args" : [e.name,"Welcome to "+ e.name],
										"timestamp" : new Date().getTime()/1000
									};
		e.messages.push(welcome);

	}
	function welcomeMsg()
	{
		var welcome = {
										"user" : "AceChat",
										"command" : "SYSTEM",
										"args" : ["Default Channel","Welcome to AceChat! Type /help for a list of commands"],
										"timestamp" : new Date().getTime()/1000
									};
		return welcome;
	}


  //gets user list from server, returns as array of strings
  function requestUsrList()
  {
		var msg = {
						"command" : "USERLIST",
						"args" : []
							};
		send(msg);
  }

  //joins the channels specified by a string
	//optional msg
  function joinChannel(e, s="")
  {
		var found = false;
		var tmp;
		for(var i =0;i<channels.length;++i)
		{
			if(channels[i].name == e)
			{
				found = true;
				tmp = channels[i];
			}
		}
		if (!!channels && found)
		{
			channel = tmp;
			updateTopBar();
			channel.messages.push(s);
			printChannelMessages(channel);
		}
		else
		{

			var msg = {
									"command" : "JOIN",
									"args" : [e]
								};
			send(msg);
			tmp = new channelObj(e);
			channels.push(tmp);
			channel = tmp;
			channel.messages.push(s);
			chanMsg(channel);
			updateTopBar();
			requestChanList();
			printChannelMessages(tmp);
		}
  }

  //leaves the channels specified by an array of channelObjs
  function part(e)
  {

		var arr;
		for (var c in e)
		{
			if(c.name)
				arr.push(c.name);
		}
    var msg = {
								"command" : "PART",
								"args" : c
							};
    send(msg);

		for (var i in e)
		{
			var tmp = channels.indexOf(e[i]);
			if(tmp > -1)
				channels.splice(tmp,1);
		}
		populateChannelList();
		if(channels.length == 0)
			logout();
		if(channels.indexOf(channel) == -1)
		{
			joinChannel(channels[0].name);
		}
  }

  //invite users to channel
  //args in the form [channel name, user0, user1,..,usern]
  function invite(e)
  {
    var msg = {
								"command" : "INVITE",
								"args" : e
							};
    send(msg);
  }

  //list channels on server
  function requestChanList()
  {
    var msg = {
								"command" : "CHANLIST",
								"args" : []
							};
    send(msg); //get list from server?
  }

  function createCookie(name,value,days) 
	{
    if (days) {
      var date = new Date();
      date.setTime(date.getTime()+(days*24*60*60*1000));
      var expires = "; expires="+date.toUTCString();
    }
    else 
    {
      var expires = "";
    }
    document.cookie = name+"="+value+expires+"; path=/";
  }

	//I'm so sorry
	function help()
	{
		//join
		msgTxt = "/join &lt;channel&gt;................join a channel<br>";

		//part
		msgTxt += "/part [channel]................leave a channel<br>";

		//logoff
		msgTxt += "/logoff........................part all channels and quit<br>";

		//logout
		msgTxt += "/logout........................same as /logoff<br>";

		//msg
		msgTxt += "/msg &lt;UserName&gt; &lt;Message&gt;......private message a user<br>";

		//whoami
		msgTxt += "/whoami........................computer aided introspection<br>";

		//standard message
		msgTxt += "&lt;message&gt;......................send message to your current channel<br>";

		//help
		msgTxt += "/help..........................show this dialog";
		msg = {
						"user" : "AceChat",
						"command" : "SYSTEM",
						"args" : [channel, msgTxt],
						"timestamp" : new Date().getTime()/1000
					};	
		channel.messages.push(msg);
		printChannelMessages(channel);
	}

	
	function logout()
	{
		createCookie("user","",-1);
		sock.close();
		window.location="login.html";

	}

	//param: channelObj
	function printChannelMessages(e)
	{
		document.getElementById("chat-log").innerHTML="";
		if(e.messages)
		{
			for(var i in e.messages)
			{
				if(e.messages[i].args && e.messages[i].args[1])
				{
					var msgHeader="";
					var msgText="";
					var d = new Date(e.messages[i].timestamp*1000);
					var ts = "" + ("0"+d.getHours()).slice(-2)+":"+("0"+d.getMinutes()).slice(-2)+":"+("0"+d.getSeconds()).slice(-2);
					msgHeader += ts+"  ";
					if(e.messages[i].command=="PRIVMSG")
						msgHeader += "[PRV]";
					if(e.messages[i].command=="ERROR")
						msgHeader += "[ERR]";
					if(e.messages[i].command=="SYSTEM")
						msgHeader += "[SYS]";
					msgHeader += e.messages[i].user+" > ";
					msgText += e.messages[i].args[1];
					msgHeader = "<div class=\"msgHeader\"><code>"+msgHeader+"</code></div>";
					msgText = "<div class=\"msgText\"><code>"+msgText+"</code></div>";

					document.getElementById("chat-log").innerHTML+="<div class=\"msgRow\">"+msgHeader + msgText+ "</div>";
					document.getElementById("chat-log").innerHTML+="<div class=\"msgRow\"><div class=\"spacer\"><br></div><div class=\"spacer\"><br></div></div>";

				}
			}
			document.getElementById("chat-log-wrapper").scrollTop=document.getElementById("chat-log-wrapper").scrollHeight;
		}
	}

  function parseInput()
  {
    var msgTxt = document.getElementById("chat-prompt").value;
    var msgArr = msgTxt.split(" ");
    var msg;
    document.getElementById("chat-prompt").value = "";
requestUsrList();
requestChanList();
updateTopBar();
    
    //if input begins with /msg validUsrName, send private message
    if (msgTxt.match(/^\/msg(\s|$)/) && !!~usrList.indexOf(msgArr[1]))
    {
			msgTxt = msgTxt.replace(/</g, "&lt;");
			msgTxt = msgTxt.replace(/>/g, "&gt;");
      msgArr.shift();
			u = msgArr[0];
      msgArr.shift();
      msgTxt = msgArr.join(" ");
      msg = {
							"command" : "PRIVMSG",
							"args" : [u,msgTxt]
						};
      send(msg);
    }

		//if input begins with /msg invalidUsrName, throw error
		else if (msgTxt.match(/^\/msg(\s|$)/) && !~usrList.indexOf(msgArr[1]))
    {
			errorHandler("Invalid User Name");
    }

		//join
		else if(msgTxt.match(/^\/join\s+[^\s]+/))
		{
			msgTxt = msgTxt.replace(/</g, "&lt;");
			msgTxt = msgTxt.replace(/>/g, "&gt;");
			msgArr.shift();
			arr = msgArr.join(" ").match(/[^<>]+/);
			joinChannel(arr[0].trim());
		}
		else if(msgTxt.match(/^\/join\s+[\s<>]*/g)) 
		{
			errorHandler("Invalid channel name");
		}
		else if(msgTxt === "/join")
		{
			errorHandler("Must enter a channel name");
		}
		
		//part
		else if(msgTxt.match(/^\/part\s+[^\s<>][^<>]*/))
		{
			msgArr.shift();
			arr = msgArr.join(" ").match(/[^<>]+/);
			if(!!~channels.indexOf(arr[0].trim()))
				part([channels[getChannel(arr[0].trim())]]);
			else
				errorHandler("You are not in that channel");
		}
		else if(msgTxt.match(/^\/part\s+[\s<>]*/g)) 
		{
			errorHandler("Invalid channel name");
		}
		//part with no args should leave the current channel
		else if(msgTxt === "/part")
		{
			part([channel]);
		}

    //logout, logoff
    //parts all channels, logs out
    else if (msgTxt.match(/^\/logoff(\s|$)/) || msgTxt.match(/^\/logout(\s|$)/))
    {
			logout();
    }

		//whoami
		else if (msgTxt.match(/^\/whoami\s*/))
		{
			msg = {
							"user" : "AceChat",
							"command" : "SYSTEM",
							"args" : [channel, userName],
							"timestamp" : new Date().getTime()/1000
						};
			channel.messages.push(msg);
			printChannelMessages(channel);
		}

		//help
		else if (msgTxt.match(/^\/help\s*/))
		{
			help();
		}

    //default, send message to current channel
    else if (msgTxt != "" && msgTxt != null)
		{
			msgTxt = msgTxt.replace(/</g, "&lt;");
			msgTxt = msgTxt.replace(/>/g, "&gt;");
      msg = {
              "command" : "MSG",
							"args" : [channel.name, msgTxt]
						};
      send(msg);
    }
  }

</script>
