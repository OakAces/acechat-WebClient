<!-- NOTE:: This uses a cookie to pass the username from the login screen
	    to the client screen. Chrome does not support cookies for local 
	    files. It works in Chrome when deployed, but it must
	    be tested locally in a different browser - no longer true; works locally 
			in chrome if pointed to local server
-->

<html>
  <head>

    <link rel="stylesheet" type="text/css" href="webUI.css">
		<title>AceChat</title>

  </head>

  <body id="body" class="body">
    <div class="left-column">
      <h3>
				Channel List
      </h3>
      <div id="channel-list">
      </div>

      <button class="logout-button"name="logout"type="button" onclick="logout();">LOGOUT</button>
    </div>

    <!--top bar-->
    <div class="top-bar">
		<code id="channel-title"></code>
    </div>

    <!--right -->
    <div class="right">
      <h3>
				Online
      </h3>
      <div id="online-list">
      </div>
			<h2 id="online-channel-header">
			</h2>
			<div id="online-channel-list">
			</div>
    </div>

    <!--center-->
    <div class="center">
			<div id="chat-log-wrapper">
				<div id="chat-log">
				</div>
      </div>

      <div class="textarea">
	>&nbsp
	<div class="textbox">
	  <input type="text"autocomplete="off" placeholder="Say Something!"id="chat-prompt"onkeydown="if(event.keyCode == 13)
											parseInput();"/>
	</div>
	<div class="textbutton">
	  <input type="button" id="textbutton" Value="Send" onclick="parseInput();"/>
	</div>
      </div>

    </div>

  </body>
</html>
  
<script type="text/javascript">
	var server = getCookie("server");
	
	if(server == "")
	{
		window.location="login.html";
	}

	var sock = new WebSocket("ws://"+server);

	var userName;

  //current channel
  var channel;

	//store lists retrieved from server
	var usrList = [];
	var chanUsrList = [];

  //channels currently "joined"
  var channels = [];

	//all channels on server
	var chanList = [];

	sock.onopen= function()
	{
		//login with server
		userName = getCookie("user");
		//must be logged in to access this page
		
		if(userName.toLowerCase() == "acechat"|| !userName.match(/^[A-z0-9]{1,10}$/))
		{
			logout();
		}
		var usrMsg = {
										"command" : "USER",
										"args" : [userName]
								 };
		send(usrMsg);

		joinChannel("Default Channel",welcomeMsg());
		requestUsrList();
		requestChanList();
	};

	sock.onclose = function()
	{
		document.getElementById("body").innerHTML="<p style='color:white'>Failed to connect to server</p>";
	};

	function getCookie(cname) 
	{
		var name = cname + "=";
		var ca = document.cookie.split(';');
		for(var i = 0; i <ca.length; i++) {
			var c = ca[i];
			while (c.charAt(0)==' ') {
				c = c.substring(1);
			}
			if (c.indexOf(name) == 0) {
				return c.substring(name.length,c.length);
			}
		}
		return "";
	} 

	//updates top bar and online-channel-list header
	function updateTopBar()
	{
		document.getElementById("channel-title").innerHTML = channel.name;
		document.getElementById("online-channel-header").innerHTML = channel.name;
	}

	function populateChannelList()
	{
		document.getElementById("channel-list").innerHTML="";
		for(var i=0;i<chanList.length;++i)
		{
			var btn = '<button class="channel-button" onclick="joinChannel(\''+chanList[i].name+'\');"><code>'+chanList[i].name+'</code></button>';
			document.getElementById("channel-list").innerHTML+=btn+"<br>";
		}
	}

	//define channel as local class
	function channelObj(name)
	{
		this.name = name;
		//messages is a list of JSON object messages from the server.
		//client messages must be wrapped in JSON objects
		this.messages = [];
	}

	function populateOnlineChannelList() //notimplemented serverside yet
	{
		document.getElementById("online-channel-list").innerHTML="";
		for(var i=0;i<chanUsrList.length;++i)
		{
			var arg = "'/msg ";
			arg += chanUsrList[i];
			arg+=" '";
			var btn = '<button class="online-button" onclick="getElementById(\'chat-prompt\').value='+arg+'"><code>'+chanUsrList[i]+'</code></button>';
			document.getElementById("online-channel-list").innerHTML+=btn+"<br>";
		}
	}
	
	function populateOnlineList()
	{
		document.getElementById("online-list").innerHTML="";
		for(var i=0;i<usrList.length;++i)
		{
			var arg = "'/msg ";
			arg += usrList[i];
			arg+=" '";
			var btn = '<button class="online-button" onclick="getElementById(\'chat-prompt\').value='+arg+'"><code>'+usrList[i]+'</code></button>';
			document.getElementById("online-list").innerHTML+=btn+"<br>";
		}
	}

	function chanInChanList(s)
	{
		for (var i in chanList)
		{
			if(chanList[i].name == s)
				return i;
		}
		return null;
	}


  //sends object to sever
  function send(e)
  {
		sock.send(JSON.stringify(e));
	}

	//recieve data from server
	sock.onmessage = function(event)
	{
		var msg = JSON.parse(event.data);
		//do something
		switch(msg.command){ 
			case "USERLIST":
				usrList = msg.args;
				populateOnlineList();
				break;
			case "CHANLIST":
				tmp = msg.args;
				for (c in tmp)
				{
					if (chanInChanList(tmp[c]) == null)
					{
						chanList.push(new channelObj(tmp[c]));
					}
				}
				for (c in chanList)
				{
					if (tmp.indexOf(chanList[c].name) == -1)
						chanList.splice(c,1);
				}
				populateChannelList();
				break;
			case "MSG":
				var msgTxt = msg.args[1];
				msgTxt = msgTxt.replace(/</g, "&lt;");
				msgTxt = msgTxt.replace(/>/g, "&gt;");
				msg.args[1] = msgTxt;
				channels[getChannel(msg.args[0])].messages.push(msg);
				printChannelMessages(channel);
				break;
			case "PRIVMSG":
				var msgTxt = msg.args[1];
				msgTxt = msgTxt.replace(/</g, "&lt;");
				msgTxt = msgTxt.replace(/>/g, "&gt;");
				msg.args[1] = msgTxt;
				for(var i in channels)
				{
					channels[i].messages.push(msg);
				}
				printChannelMessages(channel);
				break;
			case "JOIN":
				if(channel == channels[getChannel(msg.args[0])])
				{
					chanUsrList = [];
					for(var k = 1; k < msg.args.length;++k)
						chanUsrList.push(msg.args[k]);
					populateOnlineChannelList();
				}
				var tmp =""+msg.user+" JOINED "+msg.args[0];
				msg.user = "AceChat";
				msg.args.push(tmp);
				channels[getChannel(msg.args[0])].messages.push(tmp);
				break;
			case "PART":
				if(channel == channels[getChannel(msg.args[0])])
				{
					chanUsrList = [];
					for(var k = 1; k < msg.args.length;++k)
						chanUsrList.push(msg.args[k]);
					populateOnlineChannelList();
				}
				var tmp =""+msg.user+" PARTED "+msg.args[0];
				msg.user = "AceChat";
				msg.args.push(tmp);
				channels[getChannel(msg.args[0])].messages.push(tmp);
				break;
			case "ERROR":
				errorHandler(msg.args[0]);
				break;
		}
	};

	window.onload = function focus()
	{
		document.getElementById('chat-prompt').focus();
	};

	//input: channel name (string)
	//output: index of channelObj in channels
	function getChannel(s)
	{
		for(var i in channels)
		{
			if(channels[i].name == s)
				return i;
		}
		return null;
	}


  	//accepts a string containing an error message. 
	//server errors must be wrapped in the onmessage function
	function errorHandler(e)
	{
		msg = {
						"user" : "AceChat",
						"command" : "ERROR",
						"args" : [channel,e],
						"timestamp" : new Date().getTime()/1000
					};

		channel.messages.push(msg);
		printChannelMessages(channel);
		
	}


	function chanMsg(e)
	{
		var welcome = {
										"user" : "AceChat",
										"command" : "SYSTEM",
										"args" : [e.name,"Welcome to "+ e.name],
										"timestamp" : new Date().getTime()/1000
									};
		e.messages.push(welcome);
	}

	function welcomeMsg()
	{
		var welcome = {
										"user" : "AceChat",
										"command" : "SYSTEM",
										"args" : ["Default Channel","Welcome to AceChat! Type /help for a list of commands"],
										"timestamp" : new Date().getTime()/1000
									};
		return welcome;
	}

  //gets user list from server, returns as array of strings
  function requestUsrList()
  {
		var msg = {
						"command" : "USERLIST",
						"args" : []
							};
		send(msg);
  }

  //joins the channels specified by a string
	//optional msg
  function joinChannel(e, s="")
  {
		var found = false;
		var tmp;
		for(var i =0;i<channels.length;++i)
		{
			if(channels[i].name == e)
			{
				found = true;
				tmp = channels[i];
			}
		}
		if (!!channels && found)
		{
			channel = tmp;
			updateTopBar();
			channel.messages.push(s);
			printChannelMessages(channel);
		}
		else
		{

			var msg = {
									"command" : "JOIN",
									"args" : [e]
								};
			send(msg);
			tmp = new channelObj(e);
			channels.push(tmp);
			channel = tmp;
			channel.messages.push(s);
			chanMsg(channel);
			updateTopBar();
			//requestChanList();
			printChannelMessages(tmp);
		}
  }

  //leaves the channel specified by a channelObj
  function part(e)
  {
    var msg = {
								"command" : "PART",
								"args" : [e.name]
							};
    send(msg);

		var tmp = channels.indexOf(e);
		if(tmp > -1)
			channels.splice(tmp,1);
		//populateChannelList();
		if(channels.length == 0)
			logout();
		if(channels.indexOf(channel) == -1)
		{
			joinChannel(channels[0].name);
		}
  }

  //invite users to channel
  //args in the form [channel name, user0, user1,..,usern]
	//TODO
  function invite(e)
  {
    var msg = {
								"command" : "INVITE",
								"args" : e
							};
    send(msg);
  }

  function requestChanList()
  {
    var msg = {
								"command" : "CHANLIST",
								"args" : []
							};
    send(msg); 
  }

  function createCookie(name,value,days) 
	{
    if (days) {
      var date = new Date();
      date.setTime(date.getTime()+(days*24*60*60*1000));
      var expires = "; expires="+date.toUTCString();
    }
    else 
    {
      var expires = "";
    }
    document.cookie = name+"="+value+expires+"; path=/";
  }

	function help()
	{
		//join
		msgTxt = "/join &lt;channel&gt;............................join a channel<br>";

		//part
		msgTxt += "/part [channel]............................leave a channel<br>";

		//logoff
		msgTxt += "/logoff....................................part all channels and quit<br>";

		//logout
		msgTxt += "/logout....................................same as /logoff<br>";

		//msg
		msgTxt += "/msg &lt;UserName&gt; &lt;Message&gt;..................private message a user<br>";

		//whoami
		msgTxt += "/whoami....................................computer aided introspection<br>";

		//standard message
		msgTxt += "&lt;message&gt;..................................send message to your current channel<br>";

		//invite
		msgTxt += "/invite &lt;user0&gt; [user1]...[usern]..........invite users to a channel *experimental*<br>"

		//help
		msgTxt += "/help......................................show this dialog";

		msg = {
						"user" : "AceChat",
						"command" : "SYSTEM",
						"args" : [channel, msgTxt],
						"timestamp" : new Date().getTime()/1000
					};	
		channel.messages.push(msg);
		printChannelMessages(channel);
	}

	
	function logout()
	{
		createCookie("user","",-1);
		sock.close();
		window.location="login.html";
	}

	//param: channelObj
	function printChannelMessages(e)
	{
		document.getElementById("chat-log").innerHTML="";
		if(e.messages)
		{
			for(var i in e.messages)
			{
				if(e.messages[i].args && e.messages[i].args[1])
				{
					var msgHeader="";
					var msgText="";
					var d = new Date(e.messages[i].timestamp*1000);
					var ts = "" + ("0"+d.getHours()).slice(-2)+":"+("0"+d.getMinutes()).slice(-2)+":"+("0"+d.getSeconds()).slice(-2);
					msgHeader += ts+"  ";
					if(e.messages[i].command=="PRIVMSG")
						msgHeader += "[PRV]";
					if(e.messages[i].command=="ERROR")
						msgHeader += "[ERR]";
					if(e.messages[i].command=="SYSTEM")
						msgHeader += "[SYS]";
					msgHeader += e.messages[i].user+" > ";
					msgText += e.messages[i].args[1];
					msgHeader = "<div class=\"msgHeader\"><code>"+msgHeader+"</code></div>";
					msgText = "<div class=\"msgText\"><code>"+msgText+"</code></div>";

					document.getElementById("chat-log").innerHTML+="<div class=\"msgRow\">"+msgHeader + msgText+ "</div>";
					document.getElementById("chat-log").innerHTML+="<div class=\"msgRow\"><div class=\"spacer\"><br></div><div class=\"spacer\"><br></div></div>";

				}
			}
			document.getElementById("chat-log-wrapper").scrollTop=document.getElementById("chat-log-wrapper").scrollHeight;
		}
	}

  function parseInput()
  {
    var msgTxt = document.getElementById("chat-prompt").value;
    var msgArr = msgTxt.split(" ");
    var msg;
    document.getElementById("chat-prompt").value = "";
    
    //if input begins with /msg validUsrName, send private message
    if (msgTxt.match(/^\/msg(\s)/) && !!~usrList.indexOf(msgArr[1]))
    {
      msgArr.shift();
			u = msgArr[0];
      msgArr.shift();
      msgTxt = msgArr.join(" ");
      msg = {
							"command" : "PRIVMSG",
							"args" : [u,msgTxt]
						};
      send(msg);
    }

		//if input begins with /msg invalidUsrName, throw error
		else if (msgTxt.match(/^\/msg(\s|$)/) && !~usrList.indexOf(msgArr[1]))
    {
			errorHandler("Invalid User Name");
    }

		//join
		else if(msgTxt.match(/^\/join\s+[^\s]+/))
		{
			msgArr.shift();
			arr = msgArr.join(" ").match(/[^<>]+/);
			joinChannel(arr[0].trim());
		}
		else if(msgTxt.match(/^\/join\s+[\s<>]*/g)) 
		{
			errorHandler("Invalid channel name");
		}
		else if(msgTxt === "/join")
		{
			errorHandler("Must enter a channel name");
		}
		
		//part
		else if(msgTxt.match(/^\/part\s+\S+[.]*/))
		{
			msgArr.shift();
			arr = msgArr.join(" ").trim();
			if(channels[getChannel(arr)] != null)
			{
				part(channels[getChannel(arr)]);
			}
			else
				errorHandler("You are not in that channel");
		}
		//part with no args should leave the current channel
		else if(msgTxt.match(/^\/part\s*/))
		{
			part(channel);
		}

    //logout, logoff
    //**parts all channels**, logs out
		//ideally would part all channels, but it doesn't, and that's okay too.
    else if (msgTxt.match(/^\/logoff(\s|$)/) || msgTxt.match(/^\/logout(\s|$)/))
    {
			logout();
    }

		//whoami
		else if (msgTxt.match(/^\/whoami\s*/))
		{
			msg = {
							"user" : "AceChat",
							"command" : "SYSTEM",
							"args" : [channel, userName],
							"timestamp" : new Date().getTime()/1000
						};
			channel.messages.push(msg);
			printChannelMessages(channel);
		}

		//invite with one valid username
		else if (msgTxt.match(/^\/invite(\s)/))// && !!~chanList.indexOf(chanInChanList(msgArr[1])) && !!~usrList.indexOf(msgArr[2]))
		{
			c = [msgArr[1]];
			u = [msgArr[2]];
      invite(c.concat(u));
      console.log(c.concat(u));

		}







		//help
		else if (msgTxt.match(/^\/help\s*/))
		{
			help();
		}

		//invalid command
		else if (msgTxt.match(/^\/.*/))
		{
			errorHandler("Invalid Command");
		}

    //default, send message to current channel
    else if (msgTxt != "" && msgTxt != null)
		{
      msg = {
              "command" : "MSG",
							"args" : [channel.name, msgTxt]
						};
      send(msg);
    }
  }

</script>
