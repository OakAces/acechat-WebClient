<!-- NOTE:: This uses a cookie to pass the username from the login screen
	    to the client screen. Chrome does not support cookies for local 
	    files. It **should** work in Chrome when deployed, but it must
	    be tested locally in a different browser
-->

<html>
  <head>

    <link rel="stylesheet" type="text/css" href="webUI.css">

  </head>

  <body class="body">
    <div class="left-column">
      <h3>
				Channel List
      </h3>
      <div id="channel-list">

			<button class="channel-button">test</button>

      </div>

      <button class="logout-button"name="logout"type="button" onclick="logout();">LOGOUT</button>
    </div>

    <!--top bar-->
    <div class="top-bar">
		<code id="channel-title">test</code>
    </div>

    <!--right -->
    <div class="right">
      <h3>
	Online
      </h3>
      <div id="online-list">
				<button class="online-button">test</button>
      </div>
    </div>

    <!--center-->
    <div class="center">
			<div id="chat-log-wrapper">
				<div id="chat-log">
				</div>
      </div>

      <div class="textarea">
	>&nbsp
	<div class="textbox">
	  <input type="text"autocomplete="off" placeholder="Say Something!"id="chat-prompt"onkeydown="if(event.keyCode == 13)
											parseInput();"/>
	</div>
	<div class="textbutton">
	  <input type="button" id="textbutton" Value="Send" onclick="parseInput();"/>
	</div>
      </div>

    </div>

  </body>

</html>
  
<script src ="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script type="text/javascript">
	

  //current channel
  var channel = new channelClass("Default Channel");
	welcomeMsg(channel);
	chanMsg(channel);

  //channels currently "joined"
  var channels = [channel];
	var chanList = channels;

	//store lists retrieved from server
	var usrList = [];

	//DEBUG
	usrList.push("Dan");
	usrList.push("Anthony");

	var sock = new WebSocket("ws://127.0.0.1");

	joinChannel(channel.name);


  //must be logged in to access this page
  if(!document.cookie)
  {
    window.location="login.html";
  }

	function updateTopBar()
	{
		document.getElementById("channel-title").innerHTML = channel.name;
	}

	function populateChannelList()
	{
		document.getElementById("channel-list").innerHTML="";
		for(var i=0;i<chanList.length;++i)
		{
			var btn = '<button class="channel-button" onclick="joinChannel(\''+chanList[i].name+'\');"><code>'+chanList[i].name+'</code></button>';
			document.getElementById("channel-list").innerHTML+=btn+"<br>";
		}
	}

	//define channel as local class
	function channelClass(name)
	{
		this.name = name;
		//messages is a list of JSON object messages from the server.
		//client messages must be wrapped in JSON objects
		this.messages = [];
	}
	
	function populateOnlineList()
	{
		document.getElementById("online-list").innerHTML="";
		for(var i=0;i<usrList.length;++i)
		{
			var arg = "'/msg ";
			arg += usrList[i];
			arg+=" '";
			var btn = '<button class="online-button" onclick="getElementById(\'chat-prompt\').value='+arg+'"><code>'+usrList[i]+'</code></button>';
			document.getElementById("online-list").innerHTML+=btn+"<br>";
		}
	}


  //sends object to sever
  function send(e)
  {
		sock.send(JSON.stringify(e));
	}

	//recieve data from server
	sock.onmessage = function(event)
	{
		var msg = JSON.parse(event.data);
		//do something
		switch(msg.command){ 
			case "USERLIST":
				usrList = msg.args;
				populateOnlineList();
				break;
			case "CHANLIST":
				chanList = msg.args;
				populateChannelList();
				break;
			case "MSG":
				getChannel(msg.args[0]).messages.push(msg);
				if(channel == getChannel(msg.args[0]))
					printChannelMessages(channel);
				break;
			case "PRIVMSG":
				for(var i in channels)
				{
					channels[i].messages.push(msg);
				}
				printChannelMessages(channel);
				break;
			case "JOIN":
				var tmp =""+msg.user+" JOINED "+msg.args[0];
				msg.user = "AceChat";
				msg.args.push(tmp);
				getChannel(msg.args[0]).messages.push(tmp);
				if(channel == getChannel(msg.args[0]))
					printChannelMessages(channel);
				break;
			case "PART":
				var tmp =""+msg.user+" PARTED "+msg.args[0];
				msg.user = "AceChat";
				msg.args.push(tmp);
				getChannel(msg.args[0]).messages.push(tmp);
				if(channel == getChannel(msg.args[0]))
					printChannelMessages(channel);
				break;


		}
	};

	window.onload = function focus()
	{
		document.getElementById('chat-prompt').focus();
	};

	//input: channel name (string)
	//output: channelObj
	function getChannel(s)
	{
		for(var i in chanList)
		{
			if(chanList[i].name == s)
				return chanList[i];
		}
		return null;
	}


  //login with server
  var userName = document.cookie.split('=')[1];
	if(userName.toLowerCase() == "acechat" || userName.match(/[<>]+/) || userName.match(/&gt;/) || userName.match(/&lt;/))
		logout();
  var usrMsg = {
									"command" : "USER",
									"args" : [userName]
							 };
  send(usrMsg);


	function chanMsg(e)
	{
		var welcome = {
										"user" : "AceChat",
										"command" : "PRIVMSG",
										"args" : [e.name,"Welcome to "+ e.name],
										"timestamp" : new Date().getTime()/1000
									};
		e.messages.push(welcome);

	}
	function welcomeMsg(e)
	{
		var welcome = {
										"user" : "AceChat",
										"command" : "PRIVMSG",
										"args" : [e.name,"Welcome to AceChat! Type /help for a list of commands"],
										"timestamp" : new Date().getTime()/1000
									};
		e.messages.push(welcome);


	}


  //gets user list from server, returns as array of strings
  function requestUsrList()
  {
		var msg = {
						"command" : "USERLIST",
						"args" : []
							};
		send(msg);
  }

  //joins the channels specified by a string
  function joinChannel(e)
  {
		console.log(e);
		populateChannelList();
		populateOnlineList();
		updateTopBar();
		var found = false;
		var tmp;
		for(var i =0;i<channels.length;++i)
		{
			if(channels[i].name == e)
			{
				found = true;
				tmp = channels[i];
			}
		}
		if (!!channels && found)
		{
			channel = tmp;
			updateTopBar();
			printChannelMessages(channel);
		}
		else
		{

			var msg = {
									"command" : "JOIN",
									"args" : [e]
								};
			send(msg);
			tmp = new channelClass(e);
			channels.push(tmp);
			channel = tmp;
			chanMsg(channel);
			updateTopBar();
			populateChannelList();
			printChannelMessages(tmp);
		}
  }

  //leaves the channels specified by an array of channelObjs
  function part(e)
  {

		var arr;
		for (var c in e)
		{
			if(c.name)
				arr.push(c.name);
		}
    var msg = {
								"command" : "PART",
								"args" : c
							};
    send(msg);

		for (var i in e)
		{
			var tmp = channels.indexOf(e[i]);
			if(tmp > -1)
				channels.splice(tmp,1);
		}
		populateChannelList();
		if(channels.length == 0)
			logout();
		if(channels.indexOf(channel) == -1)
		{
			joinChannel(channels[0].name);
		}
  }

  //invite users to channel
  //args in the form [channel name, user0, user1,..,usern]
  function invite(e)
  {
    var msg = {
								"command" : "INVITE",
								"args" : e
							};
    send(msg);
  }

  //list channels on server
  function requestChanList()
  {
    var msg = {
								"command" : "CHANLIST",
								"args" : []
							};
    send(msg); //get list from server?
  }

  function createCookie(name,value,days) 
	{
    if (days) {
      var date = new Date();
      date.setTime(date.getTime()+(days*24*60*60*1000));
      var expires = "; expires="+date.toUTCString();
    }
    else 
    {
      var expires = "";
    }
    document.cookie = name+"="+value+expires+"; path=/";
  }

	//I'm so sorry
	function help()
	{
		//join
		msgTxt = "/join &lt;channel&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
			+ "join a channel<br>";

		//part
		msgTxt += "/part &lt;channel&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
			+ "leave a channel<br>";

		//logoff
		msgTxt += "/logoff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
			+ "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
			+ "part all channels and quit<br>";

		//logout
		msgTxt += "/logout&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
			+ "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
			+ "same as /logoff<br>";

		//msg
		msgTxt += "/msg &lt;UserName&gt; &lt;Message&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
			+ " private message a user<br>";

		//whoami
		msgTxt += "/whoami&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
			+ "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
			+ "computer aided introspection<br>";

		//standard message
		msgTxt += "&lt;message&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
			+ "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
			+ "send message to your current channel<br>";

		//help
		msgTxt += "/help&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
			+ "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
			+ "show this dialog";
		msg = {
						"user" : "AceChat",
						"command" : "PRIVMSG",
						"args" : [channel, msgTxt],
						"timestamp" : new Date().getTime()/1000
					};	
		channel.messages.push(msg);
		printChannelMessages(channel);
	}

	
	function logout()
	{
		createCookie("user","",-1);
		sock.close();
		window.location="login.html";

	}

	//param: channelObj
	function printChannelMessages(e)
	{
		document.getElementById("chat-log").innerHTML="";
		if(e.messages)
		{
			for(var i in e.messages)
			{
				if(e.messages[i].args && e.messages[i].args[1])
				{
					var msgHeader="";
					var msgText="";
					var d = new Date(e.messages[i].timestamp*1000);
					var ts = "" + ("0"+d.getHours()).slice(-2)+":"+("0"+d.getMinutes()).slice(-2)+":"+("0"+d.getSeconds()).slice(-2);
					msgHeader += ts+"  ";
					if(e.messages[i].command=="PRIVMSG")
						msgHeader += "[PRV]";
					msgHeader += e.messages[i].user+" > ";
					msgText += e.messages[i].args[1];
					msgHeader = "<div class=\"msgHeader\"><code>"+msgHeader+"</code></div>";
					msgText = "<div class=\"msgText\"><code>"+msgText+"</code></div>";

					document.getElementById("chat-log").innerHTML+="<div class=\"msgRow\">"+msgHeader + msgText+ "</div>";
					document.getElementById("chat-log").innerHTML+="<div class=\"msgRow\"><div class=\"spacer\"><br></div><div class=\"spacer\"><br></div></div>";
				}
			}
		}
	}

  function parseInput()
  {
    var msgTxt = document.getElementById("chat-prompt").value;
    var msgArr = msgTxt.split(" ");
    var msg;
    document.getElementById("chat-prompt").value = "";
requestChanList();
populateChannelList();
populateOnlineList();
updateTopBar();
    
    //if input begins with /validUsrName, send private message
    if (msgTxt.match(/^\/msg(\s|$)/) && !!~usrList.indexOf(msgArr[1]))
    {
      msgArr.shift();
      msgArr.shift();
      msgTxt = msgArr.join(" ");
      msg = {
							"command" : "PRIVMSG",
							"args" : [msgArr[1],msgTxt]
						};
      send(msg);
    }

		//join
		else if(msgTxt.match(/^\/join\s+[^\s<>][^<>]*/) && !msgTxt.match(/&gt;/) && !msgTxt.match(/&lt;/))
		{
			msgArr.shift();
			arr = msgArr.join(" ").match(/[^<>]+/);
			joinChannel(arr[0].trim());
		}
		
		//part
		else if(msgTxt.match(/^\/part\s+[^\s<>][^<>]*/))
		{
			msgArr.shift();
			arr = msgArr.join(" ").match(/[^<>]+/);
			part([getChannel(arr[0].trim())]);
		}

    //logout, logoff
    //parts all channels, logs out
    else if (msgTxt.match(/^\/logoff(\s|$)/) || msgTxt.match(/^\/logout(\s|$)/))
    {
			logout();
    }

		//whoami
		else if (msgTxt.match(/^\/whoami\s*/))
		{
			msg = {
							"user" : "AceChat",
							"command" : "PRIVMSG",
							"args" : [channel, userName],
							"timestamp" : new Date().getTime()/1000
						};
			channel.messages.push(msg);
			printChannelMessages(channel);
		}

		//help
		else if (msgTxt.match(/^\/help\s*/))
		{
			help();
		}

    //default, send message to current channel
    else if (msgTxt != "" && msgTxt != null)
		{
      msg = {
              "command" : "MSG",
							"args" : [channel.name, msgTxt]
						};
      send(msg);
    }
  }
</script>
